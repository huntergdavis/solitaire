<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Commander Solitaire (Client-Side Only)</title>
<style>
  :root{
    --bg:#0f1221;
    --panel:#171a2d;
    --panel-2:#1f2540;
    --accent:#7c9cf5;
    --accent-2:#f59e0b;
    --good:#10b981;
    --bad:#ef4444;
    --muted:#9aa3b2;
    --card-w:88px;
    --card-h:128px;
    --radius:12px;
    --gap:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
    background: radial-gradient(1200px 800px at 70% -10%, #25306b 0%, var(--bg) 60%);
    color:#e7ecff;
  }
  header{
    padding:16px 18px;
    display:flex;
    gap:14px;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,0.08);
    background:linear-gradient(180deg, rgba(255,255,255,0.04), transparent);
  }
  header h1{ margin:0; font-weight:700; font-size:18px; letter-spacing:0.4px; }
  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  select, button{
    background:var(--panel-2);
    color:#e7ecff;
    border:1px solid rgba(255,255,255,0.12);
    padding:8px 12px;
    border-radius:10px;
    font-size:14px;
  }
  button{
    cursor:pointer; font-weight:600;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  button:hover{ transform: translateY(-1px); }
  button.primary{ background:var(--accent); border-color:transparent; color:#0b0e1c; }
  button.warn{ background:var(--bad); border-color:transparent; }
  button.ghost{ background:transparent; border-color:rgba(255,255,255,0.14); }
  button:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

  main{
    padding:16px;
    display:grid;
    grid-template-columns: 1.1fr 1fr;
    gap:16px;
  }
  @media (max-width: 1100px){ main{ grid-template-columns: 1fr; } }

  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), transparent 20%), var(--panel);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:16px;
    padding:18px;
  }
  .panel h2{ margin:0 0 10px 0; font-size:15px; letter-spacing:.3px; color:#cbd5ff; }

  .zone{ display:flex; flex-direction:column; gap:12px; }
  .row{ display:flex; flex-wrap:wrap; align-items:flex-start; gap:12px; }

  .tag{
    display:inline-flex; align-items:center; gap:8px;
    background: rgba(124,156,245,0.14);
    color:#dbe3ff;
    border:1px solid rgba(124,156,245,0.35);
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600;
  }
  .tag .swatch{ width:10px; height:10px; border-radius:3px; display:inline-block; }
  .tag .swatch.heart, .tag .swatch.diamond{ background:#ff4d6d; }
  .tag .swatch.spade, .tag .swatch.club{ background:#a7b5ff; }

  .totals{ display:flex; gap:10px; flex-wrap:wrap; }
  .pill{
    background:var(--panel-2);
    border:1px solid rgba(255,255,255,0.12);
    padding:8px 12px; border-radius:999px; font-size:13px; color:#d1d7ff;
  }
  .pill.good{ background: rgba(16,185,129,0.16); border-color: rgba(16,185,129,0.4); color:#d1fae5; }
  .pill.bad{ background: rgba(239,68,68,0.16); border-color: rgba(239,68,68,0.4); color:#fee2e2; }

  /* Card */
  .card{
    width:var(--card-w);
    height:var(--card-h);
    border-radius:12px;
    background:#fff;
    color:#111827;
    border:1px solid #e5e7eb;
    box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    position:relative;
    user-select:none;
  }
  .card.red{ color:#b21c1c; }
  .card .corner{
    position:absolute; width:26px; text-align:center; line-height:1.05;
    font-weight:800; letter-spacing:0.2px;
  }
  .card .corner.top{ top:6px; left:6px; }
  .card .corner.bot{ bottom:6px; right:6px; transform: rotate(180deg); }
  .card .rank{ font-size:14px; }
  .card .suit{ font-size:16px; margin-top:2px; }
  .card .big{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:40px; opacity:.18;
  }
  .badge{
    position:absolute; top:4px; right:4px;
    background:#111827; color:#fff; font-weight:900;
    font-size:11px; padding:4px 6px; border-radius:999px; border:1px solid rgba(0,0,0,.3);
  }
  /* enemy badge and suit mark styles */
  .badge.enemy{
    background:#5b21b6;        /* purple for enemy doubling/boss */
    border-color: rgba(0,0,0,.35);
    color:#fff;
  }
  .badge.suitmark{
    background:#2563eb;        /* blue tag marking enemy cards that ARE the level suit */
    border-color: rgba(0,0,0,.35);
    color:#fff;
  }

  .highlight{ outline:3px solid var(--accent); outline-offset:2px; }
  .role{
    position:absolute; left:6px; bottom:6px;
    background:var(--accent); color:#0b0e1c; font-weight:900;
    font-size:11px; padding:3px 6px; border-radius:6px; border:1px solid rgba(0,0,0,.2);
  }
  .suit-ring{
    position:absolute; inset:2px; border-radius:10px;
    border:2px dashed var(--accent-2); pointer-events:none;
  }

  .cols{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .stack{ display:flex; flex-wrap:wrap; gap:12px; }
  .stack .empty{
    width:var(--card-w); height:var(--card-h);
    border:2px dashed rgba(255,255,255,0.18); border-radius:12px; opacity:.6;
    display:flex; align-items:center; justify-content:center; color:#9aa3b2; font-size:12px;
  }
  .divider{ height:1px; background:rgba(255,255,255,0.08); margin:8px 0; }

  .swap-note{ font-size:13px; color:#c7cffc; }
  .action-bar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:4px; }

  .log{
    max-height:220px; overflow:auto; background:var(--panel); border:1px solid rgba(255,255,255,0.08);
    border-radius:12px; padding:10px; font-size:13px; color:#d6dcff;
  }
  .log p{ margin:6px 0; }
  .muted{ color:var(--muted); }

  details{
    background:var(--panel);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:12px;
    padding:12px;
  }
  details summary{ cursor:pointer; font-weight:700; color:#dbe3ff; }
  details .small{ color:#c8d1ff; font-size:14px; }
</style>
</head>
<body>
<header>
  <h1>Commander Solitaire</h1>
  <div class="controls">
    <label for="levelSel" class="muted">Level</label>
    <select id="levelSel" aria-label="Level">
      <option value="1">1 (easiest)</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6 (hardest)</option>
    </select>
    <button id="newGameBtn" class="primary">New Game</button>
    <button id="resetBtn" class="ghost">Reset</button>
  </div>
</header>

<main>
  <section class="panel zone">
    <h2>Board</h2>
    <div class="row totals" id="statusPills">
      <span id="roundPill" class="pill">Round —</span>
      <span id="suitPill" class="pill">Level Suit —</span>
      <span id="resultPill" class="pill">Awaiting encounter…</span>
    </div>

    <div class="cols">
      <div class="panel zone">
        <h2>Your Party</h2>
        <div class="row" id="playerRow"></div>
        <div class="row totals" id="playerTotalsRow"></div>
      </div>

      <div class="panel zone">
        <h2>Enemy Group</h2>
        <div class="row" id="enemyRow">
          <div class="stack"><div class="empty">No enemies yet</div></div>
        </div>
        <div class="row totals" id="enemyTotalsRow"></div>
      </div>
    </div>

    <!-- Playfield actions: Either swap controls OR the next-encounter button -->
    <div id="playfieldActions">
      <!-- NEXT ENCOUNTER (shown when not swapping) -->
      <div id="nextControls" class="action-bar">
        <button id="nextBtnBoard" class="primary">Next Encounter</button>
      </div>

      <!-- SWAP CONTROLS (shown only right after a win on non-boss rounds) -->
      <div id="swapBlock" style="display:none; margin-top:4px;">
        <div class="swap-note">You won this round. Swap <strong>one</strong> enemy card with one of your non-commander cards.</div>
        <div class="action-bar">
          <button id="cancelSwapBtn" class="ghost">Skip Swap</button>
          <button id="confirmSwapBtn" class="primary" disabled>Confirm Swap</button>
        </div>
      </div>
    </div>

    <div class="divider"></div>
    <details>
      <summary>Rules</summary>
      <div class="small" style="margin-top:8px;">
        Select level (1–6). Draw a commander (always in play). Draw <em>level</em> team cards; the last drawn becomes the <strong>Level Suit</strong>.
        Each game has 7 encounters: draw enemies in counts <em>level, level, level+1, level+1, level+2, level+2</em>, then a <strong>boss</strong>.
        Your cards: suit-matching cards count double. Enemy cards: <em>non-suit</em> cards count double.
        If you win a non-boss round, you may swap one enemy card with one of your team cards. Boss value = <code>rank × (3 × level)</code>.
      </div>
    </details>
  </section>

  <section class="panel zone">
    <h2>Event Log</h2>
    <div id="log" class="log" aria-live="polite"></div>
  </section>
</main>

<script>
(() => {
  // ===== Config =====
  const BOSS_ADD_ONE = false; // set true to match the simulator variant (rank+1)*(3*level)

  // ===== Utilities =====
  const SUITS = ['♠','♥','♣','♦'];
  const SUIT_NAME = ['spade','heart','club','diamond'];
  const isRed = s => (s === 1 || s === 3);
  const rankLabel = (r) => (r===1?'A':r===11?'J':r===12?'Q':r===13?'K':String(r));
  const cardValue = (r) => r;
  const shuffle = (arr) => { for (let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; };
  const buildDeck = () => { const d=[]; for(let s=0;s<4;s++) for(let r=1;r<=13;r++) d.push({suit:s,rank:r}); return shuffle(d); };
  const el=(t,a={},ch=[])=>{ const e=document.createElement(t); for(const[k,v] of Object.entries(a)){ if(k==='class') e.className=v; else if(k==='dataset'){ for(const[dk,dv] of Object.entries(v)) e.dataset[dk]=dv; } else if(k.startsWith('on')&&typeof v==='function'){ e.addEventListener(k.slice(2),v);} else e.setAttribute(k,v);} (Array.isArray(ch)?ch:[ch]).forEach(c=>{ if(c==null)return; if(typeof c==='string') e.insertAdjacentHTML('beforeend',c); else e.appendChild(c);}); return e; };

  function cardNode(card, {
    role='',
    doubleBadge=null,          // text like "×2"
    badgeClass='',             // e.g., 'enemy'
    extraBadge=null,           // optional second badge (e.g., "SUIT")
    extraBadgeClass='',        // e.g., 'suitmark'
    selectable=false,
    dataset={}
  } = {}) {
    const c = el('div', { class: `card ${isRed(card.suit) ? 'red':''}`, tabindex: selectable ? '0' : '-1', dataset }, [
      el('div', { class:'corner top' }, [
        el('div', { class:'rank' }, rankLabel(card.rank)),
        el('div', { class:'suit' }, SUITS[card.suit])
      ]),
      el('div', { class:'big' }, SUITS[card.suit]),
      el('div', { class:'corner bot' }, [
        el('div', { class:'rank' }, rankLabel(card.rank)),
        el('div', { class:'suit' }, SUITS[card.suit])
      ])
    ]);
    if (role) c.appendChild(el('div', { class:'role' }, role));
    if (doubleBadge) c.appendChild(el('div', { class:`badge ${badgeClass}` }, doubleBadge));
    if (extraBadge) c.appendChild(el('div', { class:`badge ${extraBadgeClass}` }, extraBadge));
    return c;
  }

  // ===== Game State =====
  let state=null;
  const defaultState=(level=3)=>({ level, round:-1, deck:buildDeck(), commander:null, team:[], levelSuit:null, enemy:[], lastResult:null, swap:{mode:false,selectedEnemy:null,selectedTeam:null}, over:false, win:false });

  // ===== DOM =====
  const levelSel=document.getElementById('levelSel');
  const newGameBtn=document.getElementById('newGameBtn');
  const resetBtn=document.getElementById('resetBtn');

  const playerRow=document.getElementById('playerRow');
  const enemyRow=document.getElementById('enemyRow');
  const playerTotalsRow=document.getElementById('playerTotalsRow');
  const enemyTotalsRow=document.getElementById('enemyTotalsRow');

  const roundPill=document.getElementById('roundPill');
  const suitPill=document.getElementById('suitPill');
  const resultPill=document.getElementById('resultPill');

  const logEl=document.getElementById('log');

  const nextControls=document.getElementById('nextControls');
  const nextBtnBoard=document.getElementById('nextBtnBoard');
  const swapBlock=document.getElementById('swapBlock');
  const confirmSwapBtn=document.getElementById('confirmSwapBtn');
  const cancelSwapBtn=document.getElementById('cancelSwapBtn');

  // ===== Helpers =====
  function draw(n=1){ const out=[]; for(let i=0;i<n;i++){ if(!state.deck.length) throw new Error('Deck exhausted'); out.push(state.deck.pop()); } return n===1?out[0]:out; }
  function labelCard(c){ return `${rankLabel(c.rank)}${SUITS[c.suit]}`; }
  function writeLog(text){ const p=el('p',{},text); logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }

  function startGame(){
    const lvl=parseInt(levelSel.value,10);
    state=defaultState(lvl);
    state.commander=draw(1);
    state.team=draw(lvl);
    state.levelSuit=state.team[state.team.length-1].suit;
    state.round=-1; state.over=false; state.win=false; state.enemy=[]; state.lastResult=null; state.swap={mode:false,selectedEnemy:null,selectedTeam:null};

    enemyRow.innerHTML=`<div class="stack"><div class="empty">No enemies yet</div></div>`;
    enemyTotalsRow.innerHTML='';
    writeLog(`New game at level ${lvl}. Commander: ${labelCard(state.commander)}. Level suit: ${SUITS[state.levelSuit]}.`);
    resultPill.textContent='Ready — click Next Encounter';
    resultPill.className='pill';
    updateControlsUI();
    renderAll();
  }

  function playerTotal(){
    const commander = cardValue(state.commander.rank) * (state.commander.suit===state.levelSuit?2:1);
    const team = state.team.reduce((a,c)=>a + cardValue(c.rank) * (c.suit===state.levelSuit?2:1),0);
    return commander + team;
  }
  function enemyTotal(){
    if(!state.enemy.length) return 0;
    if(state.round===6){
      const boss=state.enemy[0];
      const base=cardValue(boss.rank)+(BOSS_ADD_ONE?1:0);
      return base*(3*state.level);
    }
    return state.enemy.reduce((a,c)=>a + cardValue(c.rank) * (c.suit!==state.levelSuit?2:1),0);
  }
  function enemyCountForRound(r){
    const L=state.level;
    if(r===6) return 1;
    if(r===0||r===1) return L;
    if(r===2||r===3) return L+1;
    return L+2; // 4 or 5
  }

  function renderAll(){
    roundPill.textContent = (state.round<0)?'Round —':(state.round<6?`Round ${state.round+1} of 7`:'Boss Round');
    suitPill.innerHTML = `Suit ×2 (you) / ×2 on non-suit (enemy): <strong style="margin-left:6px">${SUITS[state.levelSuit]}</strong>`;

    // player area
    playerRow.innerHTML='';
    const commanderDouble=(state.commander.suit===state.levelSuit)?'×2':null;
    playerRow.appendChild(cardNode(state.commander,{role:'Commander',doubleBadge:commanderDouble}));
    state.team.forEach((c,idx)=>{
      const dbl=(c.suit===state.levelSuit)?'×2':null;
      const isSuitCard=(idx===state.team.length-1);
      const node=cardNode(c,{role:isSuitCard?'Suit card':'',doubleBadge:dbl,selectable:state.swap.mode,dataset:{teamIndex:idx}});
      if(isSuitCard) node.appendChild(el('div',{class:'suit-ring'}));
      if(state.swap.mode){
        node.classList.add('highlight');
        node.style.cursor='pointer';
        node.addEventListener('click', onSelectTeamForSwap);
        node.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' ') onSelectTeamForSwap(e); });
      }
      if(state.swap.selectedTeam===idx) node.style.outline='3px solid var(--good)';
      playerRow.appendChild(node);
    });

    const pTotal=playerTotal();
    playerTotalsRow.innerHTML='';
    playerTotalsRow.appendChild(el('span',{class:'pill'},`Commander ${labelCard(state.commander)} = ${cardValue(state.commander.rank)*(state.commander.suit===state.levelSuit?2:1)}`));
    playerTotalsRow.appendChild(el('span',{class:'pill'},`Team (${state.team.length}) = ${pTotal - (cardValue(state.commander.rank)*(state.commander.suit===state.levelSuit?2:1))}`));
    playerTotalsRow.appendChild(el('span',{class:'pill good'},`Your total: ${pTotal}`));

    // enemy
    if(state.enemy.length){
      enemyRow.innerHTML='';
      const wrap=el('div',{class:'stack'});
      state.enemy.forEach((c, idx) => {
        let dbl = null;
        let badgeClass = 'enemy';
        let extra = null;
        let extraClass = '';

        if (state.round === 6) {
          dbl = `×${3*state.level}${BOSS_ADD_ONE?'+1':''}`;
        } else if (c.suit !== state.levelSuit) {
          // enemy doubles on NON-suit
          dbl = '×2';
        } else {
          // enemy card is the level suit: no double, but mark clearly
          extra = 'SUIT';
          extraClass = 'suitmark';
        }

        const node = cardNode(c, {
          doubleBadge: dbl,
          badgeClass,
          extraBadge: extra,
          extraBadgeClass: extraClass,
          selectable: state.swap.mode && state.round !== 6,
          dataset: { enemyIndex: idx }
        });

        if (state.swap.mode && state.round !== 6){
          node.classList.add('highlight');
          node.style.cursor = 'pointer';
          node.addEventListener('click', onSelectEnemyForSwap);
          node.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') onSelectEnemyForSwap(e); });
        }
        if (state.swap.selectedEnemy === idx) node.style.outline = '3px solid var(--accent-2)';
        wrap.appendChild(node);
      });
      enemyRow.appendChild(wrap);

      const eTotal=enemyTotal();
      enemyTotalsRow.innerHTML='';
      if(state.round===6){
        const boss=state.enemy[0];
        const base=cardValue(boss.rank)+(BOSS_ADD_ONE?1:0);
        const bossVal=base*(3*state.level);
        enemyTotalsRow.appendChild(el('span',{class:'pill'},`Boss ${labelCard(boss)} = ${bossVal}`));
      }else{
        enemyTotalsRow.appendChild(el('span',{class:'pill'},`Enemies (${state.enemy.length})`));
      }
      enemyTotalsRow.appendChild(el('span',{class:'pill bad'},`Enemy total: ${eTotal}`));
    }

    if(state.lastResult){
      const {player,enemy,won}=state.lastResult;
      resultPill.textContent= won ? `You win the encounter! ${player} vs ${enemy}` : `Defeat this round. ${player} vs ${enemy}`;
      resultPill.className=`pill ${won?'good':'bad'}`;
    }
  }

  function updateControlsUI(){
    // If swapping, show swap controls; otherwise show Next button (unless game over)
    if(state.swap.mode){
      nextControls.style.display='none';
      swapBlock.style.display='';
      confirmSwapBtn.disabled = (state.swap.selectedEnemy==null || state.swap.selectedTeam==null);
    } else {
      swapBlock.style.display='none';
      nextControls.style.display = state.over ? 'none' : '';
      nextBtnBoard.disabled = state.over;
    }
  }

  function nextEncounter(){
    if(state.over) return;
    state.round += 1;
    state.enemy = draw(enemyCountForRound(state.round));
    if(!Array.isArray(state.enemy)) state.enemy=[state.enemy];

    const p=playerTotal();
    const e=enemyTotal();
    const won=p>e;
    state.lastResult={player:p,enemy:e,won};
    renderAll();

    if(state.round===6){
      writeLog(`Boss appears: ${labelCard(state.enemy[0])}. Boss total ${e}. ${won?'You defeated the boss!':'Boss defeated you.'}`);
    } else {
      writeLog(`Round ${state.round+1}: enemies (${state.enemy.map(labelCard).join(', ')}). ${won?'Win':'Loss'} ${p} vs ${e}.`);
    }

    if(won && state.round!==6){
      state.swap={mode:true,selectedEnemy:null,selectedTeam:null};
      updateControlsUI();
    } else {
      state.swap={mode:false,selectedEnemy:null,selectedTeam:null};
      if(!won){
        state.over=true; state.win=false;
        writeLog(`Game over at round ${state.round+1}.`);
      } else if(state.round===6 && won){
        state.over=true; state.win=true;
        writeLog(`🏆 Victory! You cleared all 7 encounters at level ${state.level}.`);
      }
      updateControlsUI();
    }
    renderAll();
  }

  // ===== Swap Handlers =====
  function onSelectEnemyForSwap(e){
    const idx=+e.currentTarget.dataset.enemyIndex;
    state.swap.selectedEnemy=idx;
    updateControlsUI(); renderAll();
  }
  function onSelectTeamForSwap(e){
    const idx=+e.currentTarget.dataset.teamIndex;
    state.swap.selectedTeam=idx;
    updateControlsUI(); renderAll();
  }
  function confirmSwap(){
    const ei=state.swap.selectedEnemy, ti=state.swap.selectedTeam;
    if(ei==null || ti==null) return;
    const enemyCard=state.enemy[ei];
    const giveCard=state.team[ti];
    state.team[ti]=enemyCard;
    writeLog(`Swapped your ${labelCard(giveCard)} with enemy ${labelCard(enemyCard)}.`);

    state.swap={mode:false,selectedEnemy:null,selectedTeam:null};
    updateControlsUI(); renderAll();
  }
  function cancelSwap(){
    state.swap={mode:false,selectedEnemy:null,selectedTeam:null};
    updateControlsUI(); renderAll();
  }

  // ===== Wire up =====
  newGameBtn.addEventListener('click', startGame);
  resetBtn.addEventListener('click', () => { if(state) startGame(); });
  nextBtnBoard.addEventListener('click', nextEncounter);
  confirmSwapBtn.addEventListener('click', confirmSwap);
  cancelSwapBtn.addEventListener('click', cancelSwap);

  // Auto-start
  startGame();
})();
</script>
</body>
</html>

